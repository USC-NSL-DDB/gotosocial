# This file was generated by "weaver kube" version (devel) for the following
# application:
#
#     app: gotosocial
#     version: 5bb81ff6
#     components groups:
#     -
#       - github.com/ServiceWeaver/weaver/Main
#     -
#       - github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler
#     -
#       - github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler
#     listeners:
#     - gotosocial
#
# This file contains the following resources:
#
#     1. A Deployment for every group of components.
#     2. A HorizontalPodAutoscaler for every Deployment.
#     3. A Service for every listener.
#     4. Some Roles and RoleBindings to configure permissions.
#
# To deploy these resources, run:
#
#     kubectl apply -f /tmp/kube_5bb81ff6.yaml
#
# To view the deployed resources, run:
#
#     kubectl get all,configmaps --selector=serviceweaver/version=5bb81ff6
#
# To view a description of every resource, run:
#
#     kubectl get all,configmaps --selector=serviceweaver/version=5bb81ff6 -o custom-columns=KIND:.kind,NAME:.metadata.name,APP:.metadata.labels.serviceweaver/app,VERSION:.metadata.labels.serviceweaver/version,DESCRIPTION:.metadata.annotations.description
#
# To delete the resources, run:
#
#     kubectl delete all,configmaps --selector=serviceweaver/version=5bb81ff6

# Roles.
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: null
  name: pods-getter
  namespace: default
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - watch

---
# Role Bindings.
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  creationTimestamp: null
  name: default-pods-getter
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pods-getter
subjects:
  - kind: ServiceAccount
    name: default
    namespace: default

---
# Configuration
apiVersion: v1
data:
  config.textpb: |
    namespace:  "default"
    deployment_id:  "5bb81ff6-1888-43ea-b865-0c0ef1992ca1"
    listeners:  {
      key:  "gotosocial"
      value:  20000
    }
    groups:  {
      key:  "github.com/ServiceWeaver/weaver/Main"
      value:  "github.com/ServiceWeaver/weaver/Main"
    }
    groups:  {
      key:  "github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler"
      value:  "github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler"
    }
    groups:  {
      key:  "github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler"
      value:  "github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler"
    }
  weaver.toml: |
    [serviceweaver]
    name = "gotosocial"
    binary = "./gotosocial"
    args = ["--config-path", "config.yaml", "server", "start"]
    env = ["DEBUG=1"]

    [single]
    listeners.gotosocial = {address = "localhost:8080"}

    [multi]
    listeners.gotosocial = {address = "localhost:8080"}
kind: ConfigMap
metadata:
  annotations:
    description:
      This ConfigMap contains config files for app "gotosocial" version
      "5bb81ff6".
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: config-5bb81ff6
  namespace: default

---
# Listener Service for group github.com/ServiceWeaver/weaver/Main
apiVersion: v1
kind: Service
metadata:
  annotations:
    description: This Service forwards traffic to the "gotosocial" listener.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/listener: gotosocial
    serviceweaver/version: 5bb81ff6
  name: gotosocial-5bb81ff6
  namespace: default
spec:
  ports:
    - port: 80
      protocol: TCP
      targetPort: 20000
  selector:
    serviceweaver/name: weaver-main-5bb81ff6-e4a25d35
  type: LoadBalancer
status:
  loadBalancer: {}

---
# Deployment for group github.com/ServiceWeaver/weaver/Main
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    description: This Deployment hosts components github.com/ServiceWeaver/weaver/Main.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: weaver-main-5bb81ff6-e4a25d35
  namespace: default
spec:
  selector:
    matchLabels:
      serviceweaver/name: weaver-main-5bb81ff6-e4a25d35
  strategy: {}
  template:
    metadata:
      annotations:
        description: This Pod hosts components github.com/ServiceWeaver/weaver/Main.
      creationTimestamp: null
      labels:
        serviceweaver/app: gotosocial
        serviceweaver/name: weaver-main-5bb81ff6-e4a25d35
        serviceweaver/version: 5bb81ff6
      namespace: default
    spec:
      containers:
        - args:
            - babysitter
            - /weaver/weaver.toml
            - /weaver/config.textpb
            - github.com/ServiceWeaver/weaver/Main
          image: h21565897/gotosocial:6c0ceb77
          imagePullPolicy: IfNotPresent
          name: serviceweaver
          ports:
            - containerPort: 20000
              name: gotosocial
          resources: {}
          stdin: true
          tty: true
          volumeMounts:
            - mountPath: /weaver/weaver.toml
              name: config
              subPath: weaver.toml
            - mountPath: /weaver/config.textpb
              name: config
              subPath: config.textpb
            - mountPath: /weaver/web/
              name: host-assets
              readOnly: true
            - mountPath: /weaver/config.yaml
              name: app-config
              readOnly: true
              subPath: config.yaml
      dnsPolicy: ClusterFirst
      serviceAccountName: default
      volumes:
        - configMap:
            name: config-5bb81ff6
          name: config
        - hostPath:
            path: /home/junzhouh/gotosocial-weaver/web/
            type: Directory
          name: host-assets
        - configMap:
            name: gotosocial-config
          name: app-config
status: {}

---
# Autoscaler for group github.com/ServiceWeaver/weaver/Main
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  annotations:
    description:
      This HorizontalPodAutoscaler scales the "weaver-main-5bb81ff6-e4a25d35"
      Deployment.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: weaver-main-5bb81ff6-e4a25d35
  namespace: default
spec:
  maxReplicas: 10
  metrics:
    - resource:
        name: cpu
        target:
          averageUtilization: 80
          type: Utilization
      type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: weaver-main-5bb81ff6-e4a25d35
status:
  currentMetrics: null
  desiredReplicas: 0

---
# Deployment for group github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    description: This Deployment hosts components github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: weaver-mediarequesthandler-5bb81ff6-5be2b6d6
  namespace: default
spec:
  selector:
    matchLabels:
      serviceweaver/name: weaver-mediarequesthandler-5bb81ff6-5be2b6d6
  strategy: {}
  template:
    metadata:
      annotations:
        description: This Pod hosts components github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler.
      creationTimestamp: null
      labels:
        serviceweaver/app: gotosocial
        serviceweaver/name: weaver-mediarequesthandler-5bb81ff6-5be2b6d6
        serviceweaver/version: 5bb81ff6
      namespace: default
    spec:
      containers:
        - args:
            - babysitter
            - /weaver/weaver.toml
            - /weaver/config.textpb
            - github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler
          image: h21565897/gotosocial:6c0ceb77
          imagePullPolicy: IfNotPresent
          name: serviceweaver
          resources: {}
          stdin: true
          tty: true
          volumeMounts:
            - mountPath: /weaver/weaver.toml
              name: config
              subPath: weaver.toml
            - mountPath: /weaver/config.textpb
              name: config
              subPath: config.textpb
            - mountPath: /weaver/web/
              name: host-assets
              readOnly: true
            - mountPath: /weaver/config.yaml
              name: app-config
              readOnly: true
              subPath: config.yaml
      dnsPolicy: ClusterFirst
      serviceAccountName: default
      volumes:
        - configMap:
            name: config-5bb81ff6
          name: config
        - hostPath:
            path: /home/junzhouh/gotosocial-weaver/web/
            type: Directory
          name: host-assets
        - configMap:
            name: gotosocial-config
          name: app-config
status: {}

---
# Autoscaler for group github.com/superseriousbusiness/gotosocial/internal/weaver/MediaRequestHandler
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  annotations:
    description:
      This HorizontalPodAutoscaler scales the "weaver-mediarequesthandler-5bb81ff6-5be2b6d6"
      Deployment.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: weaver-mediarequesthandler-5bb81ff6-5be2b6d6
  namespace: default
spec:
  maxReplicas: 10
  metrics:
    - resource:
        name: cpu
        target:
          averageUtilization: 80
          type: Utilization
      type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: weaver-mediarequesthandler-5bb81ff6-5be2b6d6
status:
  currentMetrics: null
  desiredReplicas: 0

---
# Deployment for group github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    description: This Deployment hosts components github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: weaver-statusrequesthandler-5bb81ff6-0afde9d8
  namespace: default
spec:
  selector:
    matchLabels:
      serviceweaver/name: weaver-statusrequesthandler-5bb81ff6-0afde9d8
  strategy: {}
  template:
    metadata:
      annotations:
        description: This Pod hosts components github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler.
      creationTimestamp: null
      labels:
        serviceweaver/app: gotosocial
        serviceweaver/name: weaver-statusrequesthandler-5bb81ff6-0afde9d8
        serviceweaver/version: 5bb81ff6
      namespace: default
    spec:
      containers:
        - args:
            - babysitter
            - /weaver/weaver.toml
            - /weaver/config.textpb
            - github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler
          image: h21565897/gotosocial:6c0ceb77
          imagePullPolicy: IfNotPresent
          name: serviceweaver
          resources: {}
          stdin: true
          tty: true
          volumeMounts:
            - mountPath: /weaver/weaver.toml
              name: config
              subPath: weaver.toml
            - mountPath: /weaver/config.textpb
              name: config
              subPath: config.textpb
            - mountPath: /weaver/web/
              name: host-assets
              readOnly: true
            - mountPath: /weaver/config.yaml
              name: app-config
              readOnly: true
              subPath: config.yaml
      dnsPolicy: ClusterFirst
      serviceAccountName: default
      volumes:
        - configMap:
            name: config-5bb81ff6
          name: config
        - hostPath:
            path: /home/junzhouh/gotosocial-weaver/web/
            type: Directory
          name: host-assets
        - configMap:
            name: gotosocial-config
          name: app-config
status: {}

---
# Autoscaler for group github.com/superseriousbusiness/gotosocial/internal/weaver/StatusRequestHandler
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  annotations:
    description:
      This HorizontalPodAutoscaler scales the "weaver-statusrequesthandler-5bb81ff6-0afde9d8"
      Deployment.
  creationTimestamp: null
  labels:
    serviceweaver/app: gotosocial
    serviceweaver/version: 5bb81ff6
  name: weaver-statusrequesthandler-5bb81ff6-0afde9d8
  namespace: default
spec:
  maxReplicas: 10
  metrics:
    - resource:
        name: cpu
        target:
          averageUtilization: 80
          type: Utilization
      type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: weaver-statusrequesthandler-5bb81ff6-0afde9d8
status:
  currentMetrics: null
  desiredReplicas: 0

---
# Redis Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  labels:
    app: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          volumeMounts:
            - name: redis-data
              mountPath: /data
          args:
            - redis-server
            - --appendonly
            - "yes"
      volumes:
        - name: redis-data
          persistentVolumeClaim:
            claimName: redis-data-pvc

---
# Redis PersistentVolumeClaim
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# Redis Service
apiVersion: v1
kind: Service
metadata:
  name: redis
  labels:
    app: redis
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
  selector:
    app: redis
